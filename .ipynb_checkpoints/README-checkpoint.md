# Edu ML / EBPM / CF Demo App – 教育データ × ML × EBPM × CF デモ

公開データ（StudentsPerformanceInExams）やでもデータを題材に、  
**「予測 × EBPM（効果検証） × 推薦モデル × 運用ダッシュボード」**までを一つのアプリで見せるデモです。

- 建て付け：Python / Streamlit + （GCP連携）  
- テーマ：教育データ、ABテスト、因果推論、推薦、運用モニタリング  
- 目的：**実務に近い ML周りのプロダクトの「流れ」を 1 つのアプリで説明できること**

---

## 1. デモ概要

- デモURL：`https://edu-ml-app-dev-218616351259.asia-northeast1.run.app/`
- 想定ユーザー
  - 学習者・保護者・運営側（教員・教育事業者）
  - プロダクト / データ / DS・ML チームのメンバー
- このアプリで確認できること
  - 学習スコアの**予測**と、その**要因の可視化（SHAP）、ABテストとCTR（クリック率）**
  - 施策の**効果検証（t検定 / PSM / IPW）**
  - 学習コンテンツの**推薦と Precision/Recall@K による評価**
  - クリック率や利用回数などの**運用指標のダッシュボード**

---

## 2. 見どころ

このアプリでは、以下の 4 点を意識して設計しています。

1. **予測（predicts）→ 運用（dashboard）**
   - 入力フォーム → モデル推論 → 可視化(SHAP値) → 推奨アクション → ログ → ダッシュボード  
   までを一画面内・一アプリ内でつなげています。

2. **エビデンスベース（EBPM） / 因果推論の視点**
   - 施策の有効性を、平均比較だけでなく  
     **t検定・PSM（傾向スコアマッチング）・IPW**で比較・可視化し、  
     「観測データでどこまで言えるか / 限界はどこか」をコメントできる構成にしています。

3. **推薦 + 計測のセット**
   - User-based CF による推薦結果を出すだけでなく、  
     **Precision/Recall@K** で評価できるようにしています。

4. **運用・監視の意識**
   - CTR・利用回数・直近 7 日間のトレンドなど、  
     プロダクト運用でよく見る指標を簡易的なダッシュボードで確認できるようにしています。

---

## 3. 機能一覧（ページ構成）

アプリは Streamlit のマルチページで構成されています。

### 3.1 予測ページ（数学スコア予測）

- 概要  
  公開データ（StudentsPerformanceInExams）をもとに、  
  **数学スコアを予測し、SHAP で要因を説明するページ**です。
  さらに、ABテストを行い、ログからダッシュボードまで通貫しています。

- 主な機能
  - 性別 / 人種・民族 / 親の学歴 / 昼食の種類 / 試験準備コース / 読解・作文スコア 等を入力
  - モデル選択：`LinearRegression` または `LightGBM`
  - 予測精度をカードで常時表示
  - 予測された数学スコアを表示
  - SHAP のウォーターフォールプロットで、  
    「どの要因がどれだけ点数に効いているか」を可視化
  - 画面下部で **A/B コピーを提示し、クリック有無をログ**（簡易 AB テスト）

- 技術的なポイント
  - GCS から学習済みモデル（pkl）と精度（json）と特徴量リストをロード
  - One-Hot Encoding 済みのカラム順に合わせた前処理
  - `shap.TreeExplainer / LinearExplainer` を用いた SHAP 可視化
  - AB テストは、セッション・利用者を簡易にランダム割り当てし、  
    CTR（クリック率）を後段のダッシュボードで集計可能にしています。

---

### 3.2 EBPMページ（施策効果検証デモ）

- 概要  
  実務でも行っている「ある学習支援施策（例：追加のコーチングや教材提供）」の効果を、  
  **t検定 / PSM / IPW / 回帰調整** の 4 つの方法で比較するページです。

- 主な機能
  - 公開データ（StudentsPerformanceInExams）あるいはデータ（csv）を読み込み
  - `t検定` による単純な平均比較
  - `PSM（傾向スコアマッチング）` によるバランス調整後の効果推定
  - `IPW（Inverse Probability Weighting）` による重み付き平均の効果推定
  - `重回帰分析` による回帰調整の効果推定
  - バランス確認用の簡易テーブル（共変量の標準化差分など）
  - マッチング前と後のグラフから重なりを確認
  - 効果推定の比較を可視化
  - ページ内に **前提・限界（交絡・モデル依存など）をコメント**として明示

- 技術的なポイント
  - `sklearn` / `statsmodels` などを使った簡易実装
  - 傾向スコアモデル（例：ロジスティック回帰）→ マッチング / 重み付け
  - 「教育データで EBPM を回すときに、どのような考え方・注意点があるか」を  
    コードと UI で示せる構成にしています。

---

### 3.3 推薦ページ（User-based CF + Precision/Recall@K）

- 概要  
  学習コンテンツや教材を想定し、  
  **User-based Collaborative Filtering（協調フィルタリング）**で推薦を行うページです。

- 主な機能
  - ユーザー選択
  - そのユーザーに対する推薦コンテンツを上位 K 件表示
  - 推薦の「当たり具合」を簡易に評価
  - 試行用に K を入力（デフォルト 5）し、Precision/Recall@K を計算

- 技術的なポイント
  - 評価行列（ユーザー×教材）のピボット
  - コサイン類似度によるユーザー類似度計算
  - 近傍ユーザーからのスコア集約（User-based CF の素朴な実装）
  - `precision_at_k` 関数で、上位 K 件のうちどれだけ「正解アイテム」に含まれるかを算出
  - `recall_at_k` 関数で、すべての「正解アイテム」のうち、どれだけ上位 K 件に含まれるかを算出
---

### 3.4 運用ダッシュボードページ

- 概要  
  アプリ全体(今回は予測（predicts）のみ）の利用状況を簡単に把握するためのページです。

- 主な機能
  - 直近 N 日の
    - 予測ページの利用回数
    - A/B コピー別の CTR
  - 時系列のグラフやカードでの数値表示
  - 最終デプロイ時刻・リージョンなどのメタ情報（表示のみ）

- 技術的なポイント
  - `log_utils.py` からのログ読み込み（BigQuery or ローカル CSV）
  - 指標計算：CTR, 利用頻度 など
  - Streamlit での簡易可視化（`st.metric`, `st.pyplot` など）

---

## 4. アーキテクチャ（概要）

本アプリは **Streamlit を用いたマルチページ構成の教育データ分析デモ** で、以下の 4 機能を提供します：

- 予測（Predict）
- EBPM（t検定 / PSM / IPW / 回帰調整）
- 推薦（CF: Collaborative Filtering）
- 運用ダッシュボード（CTR / 利用回数 可視化）

---

/app
├── app.py # 入口ページ（ホーム）
├── pages/
│ ├── 01_predicts.py # 予測（A/Bテスト + SHAP）
│ ├── 02_EBPM.py # t検定 / PSM / IPW / 回帰調整
│ ├── 03_CV.py # User-based CF + Precision/Recall@K
│ └── 99_dashboard.py # 運用ダッシュボード（CTR, 利用回数）
└── modules/
├── model_io.py # モデル / 特徴量リストのロード（GCS / Local）
├── metrics.py # Precision@K / Recall@K
├── log_utils.py # ログ保存（local / GCS）
├── config.py # 環境変数 / GCP設定
├── guards.py # ダッシュボードの管理者ゲート
└── make_pkl_score.py # モデル学習 & RMSE/R² の保存

##  5. 技術スタック

### ■ 言語 / フレームワーク
- Python  
- Streamlit  
- （任意）FastAPI（API を分割する構成にも対応可）

### ■ ML / データ分析ライブラリ
- scikit-learn  
- LightGBM  
- SHAP（特徴量寄与の可視化）  
- pandas / numpy  

### ■ EBPM（因果推論）
- statsmodels  
- scipy（t検定）  
- scikit-learn（傾向スコア推定）

### ■ 推薦（CF）
- コサイン類似度  
- Precision@K / Recall@K（自作）

### ■ インフラ
- Google Cloud Run（デプロイ）  
- Google Cloud Storage（モデル保存）  
- BigQuery または CSV 読み込み（EBPMページ）  
- Docker  
- GitHub（ソース管理）

---

## 6. ローカル実行方法

> **GCS バケット名やプロジェクトIDは `.env` または環境変数で管理してください（リポジトリには含めない）**

---


